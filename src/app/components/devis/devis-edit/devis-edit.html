
<div class="d-flex justify-content-between">
          <h5>Lignes de produits ou services <span class="text-danger">*</span></h5>

          <div class="mb-3 d-flex">
            <label for="categorieSelect" class="form-label">Filtrer par catégorie</label>
            <select id="categorieSelect" class="form-select"
                    [(ngModel)]="selectedCategorieId"
                    (ngModelChange)="onCategorieFilterChange()">
              <option [ngValue]="undefined">-- Toutes les catégories --</option>
              <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.nom }}</option>
            </select>
          </div>
        </div>
<!-- Étape 1 : Saisie -->
<div *ngIf="!isLoading && step === 1">
  <div class="row">
    <div class="col-lg-4">
      <label class="form-label">Date d'émission <span class="text-danger">*</span></label>
      <input type="date" class="form-control" [(ngModel)]="dateDemission" (change)="errors.dateDemission = ''">
      <div class="invalid-feedback" *ngIf="errors.dateDemission">
        {{ errors.dateDemission }}
      </div>
    </div>
    <div class="col-lg-4">
      <label class="form-label">Date d'échéance <span class="text-danger">*</span></label>
      <input type="date" class="form-control" [class.is-invalid]="errors.dateEcheance" 
             [(ngModel)]="dateEcheance" (change)="errors.dateEcheance = ''">
      <div class="invalid-feedback" *ngIf="errors.dateEcheance">
        {{ errors.dateEcheance }}
      </div>
    </div>
    <div class="col-lg-4">
      <label class="form-label">Client <span class="text-danger">*</span></label>
      <select class="form-select" [class.is-invalid]="errors.clientId" 
              [(ngModel)]="clientId" (change)="errors.clientId = ''">
        <option [ngValue]="null">-- Choisir Client --</option>
        <option *ngFor="let c of clients" [ngValue]="c.id">{{c.nom}}</option>
      </select>
      <div class="invalid-feedback" *ngIf="errors.clientId">
        {{ errors.clientId }}
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-lg-3">
      <label class="form-label">Devise Départ</label>
      <select class="form-select" [(ngModel)]="deviseDepart" (change)="onDeviseDepartChange()">
        <option *ngFor="let d of devises" [value]="d.code">{{d.code}} - {{d.nom}}</option>
      </select>
    </div>
    <div class="col-lg-3">
      <label class="form-label">Devise Devis</label>
      <select class="form-select" [(ngModel)]="devise" (change)="onDeviseChange()">
        <option *ngFor="let d of devises" [value]="d.code">{{d.code}} - {{d.nom}}</option>
      </select>
    </div>
    <div class="col-lg-3 mt-2">
      <small class="text-muted">{{ getTauxDisplay() }}</small>
      <div class="d-flex align-items-center gap-2">
        <input type="number" class="form-control" [(ngModel)]="taux" 
               (input)="updateAllPricesWithTaux()" [readonly]="tauxAuto" 
               step="0.0001" min="0.0001">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" [(ngModel)]="tauxAuto" 
                 (change)="calculateTaux()">
          <label class="form-check-label">Auto</label>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <label class="form-label">Banque <span class="text-danger">*</span></label>
      <select class="form-select" [(ngModel)]="banqueId">
        <option [ngValue]="null">-- Choisir Banque --</option>
        <option *ngFor="let b of banques" [ngValue]="b.id">{{b.name}}</option>
      </select>
    </div>
  </div>

  <hr>

  <h5>Lignes de produits ou services <span class="text-danger">*</span></h5>
  <div *ngIf="errors.lignes" class="alert alert-danger">
    {{ errors.lignes }}
  </div>
  
  <div *ngFor="let ligne of lignes; let i = index" class="row mb-2 align-items-center">
    <div class="col-lg-3">
      <select class="form-select" [class.is-invalid]="errors['ligne_' + i + '_designation']" 
              [(ngModel)]="ligne.designationId" 
              (change)="onDesignationChange(ligne, i)">
        <option [ngValue]="null">-- Désignation --</option>
        <option *ngFor="let d of designations" [ngValue]="d.id" [attr.data-prix]="d.prix_unitaire">
          {{d.libelle}}
        </option>
      </select>
      <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_designation']">
        {{ errors['ligne_' + i + '_designation'] }}
      </div>
    </div>
    <div class="col-lg-1">
      <input type="number" class="form-control" [class.is-invalid]="errors['ligne_' + i + '_quantite']" 
             placeholder="Qté" [(ngModel)]="ligne.quantite" (input)="onLineChange()" min="1">
      <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_quantite']">
        {{ errors['ligne_' + i + '_quantite'] }}
      </div>
    </div>
    <div class="col-lg-2">
      <input type="number" class="form-control" [class.is-invalid]="errors['ligne_' + i + '_prix']" 
             placeholder="Prix Unitaire" [(ngModel)]="ligne.prix" (input)="onLineChange()" step="0.01" min="0">
      <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_prix']">
        {{ errors['ligne_' + i + '_prix'] }}
      </div>
    </div>
    <div class="col-lg-1">
      <input type="number" class="form-control" placeholder="Remise %" 
             [(ngModel)]="ligne.remise" (input)="onLineChange()" min="0" max="100" step="0.01">
    </div>
    <div class="col-lg-2">
      <input type="number" class="form-control" placeholder="PU Net" 
             [value]="ligne.prixNet || 0" readonly>
    </div>
    <div class="col-lg-2">
      <input type="number" class="form-control" placeholder="Total" 
             [value]="ligne.total || 0" readonly>
    </div>
    <div class="col-lg-1">
      <button class="btn btn-danger btn-sm" (click)="removeLine(i)">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <button class="btn btn-primary mt-2" (click)="addLine()">
    <i class="fas fa-plus"></i> Ajouter une ligne
  </button>

  <hr>

  <h5>Conditions financières</h5>
  <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-4">
              <label class="form-label">Commande (%)</label>
              <input type="number" class="form-control" [(ngModel)]="commande" 
                     (input)="onCommandeChange()" min="0" max="100">
            </div>
            <div class="col-lg-4">
              <label class="form-label">Livraison (%)</label>
              <input type="number" class="form-control" [(ngModel)]="livraison" 
                     (input)="onLivraisonChange()" min="0" max="100">
            </div>
            <div class="col-lg-4">
              <label class="form-label">Validité (jours)</label>
              <input type="number" class="form-control" [(ngModel)]="validiteOffre" min="1">
            </div>
            <div class="col-lg-4 mt-2">
              <label class="form-label">Délai de livraison</label>
              <input type="number" class="form-control" [(ngModel)]="delaiJours" min="1" 
                     *ngIf="delaiType === 'jours'">
              <input type="text" class="form-control" value="Déjà livré" readonly 
                     *ngIf="delaiType === 'deja_livre'">
              <input type="text" class="form-control" value="Selon planning du client" readonly 
                     *ngIf="delaiType === 'planning'">
            </div>
            <div class="col-lg-8 mt-2">
              <div class="row">
                <div class="col-lg-4">
                  <label class="form-label">Type</label>
                  <select class="form-select" [(ngModel)]="delaiType">
                    <option value="jours">Nbre Jours</option>
                    <option value="deja_livre">Déjà Livré</option>
                    <option value="planning">Planning Client</option>
                    <option value="periode">Période</option>
                  </select>
                </div>
                <div class="col-lg-4" *ngIf="delaiType === 'periode'">
                  <label class="form-label">DE</label>
                  <input type="number" class="form-control" [(ngModel)]="delaiDe" min="0">
                </div>
                <div class="col-lg-4" *ngIf="delaiType === 'periode'">
                  <label class="form-label">A</label>
                  <input type="number" class="form-control" [(ngModel)]="delaiA" min="0">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-4">
              <label class="form-label">Total HT</label>
              <input type="number" class="form-control total-ht" [value]="totalHT" readonly>
            </div>
            <div class="col-lg-4">
              <label class="form-label">TVA (%)</label>
              <div class="d-flex gap-2">
                <input type="number" class="form-control tva" [(ngModel)]="tva" 
                       (input)="calculateTotals()" [readonly]="!tvaActive" min="0" max="100">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="tvaActive" 
                         (change)="onTvaToggle()">
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <label class="form-label">Total TTC</label>
              <input type="number" class="form-control total-ttc" [value]="totalTTC" readonly>
            </div>
            <div class="col-lg-6 mt-2">
              <label class="form-label">Acompte</label>
              <input type="number" class="form-control acompte" [value]="acompte" readonly>
            </div>
            <div class="col-lg-6 mt-2">
              <label class="form-label">Solde</label>
              <input type="number" class="form-control solde" [value]="solde" readonly>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <div class="d-flex justify-content-between mt-3">
    <button class="btn btn-secondary" (click)="cancel()">
      <i class="fas fa-times"></i> Annuler
    </button>
    <button class="btn btn-success" (click)="nextStep()">
      <i class="fas fa-arrow-right"></i> Suivant
    </button>
  </div>
</div>

<!-- Étape 2 : Aperçu et Enregistrement -->
<div *ngIf="!isLoading && step === 2">
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    Vérifiez les informations ci-dessous avant d'enregistrer la Proforma.
  </div>

  <h5 class="mb-4">Aperçu de la Proforma #{{ devis.num_proforma }}</h5>
  
  <!-- Informations générales -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations générales</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-6">
              <p><strong>Client:</strong><br>{{ getClientName() }}</p>
              <p><strong>Date d'émission:</strong><br>{{ dateDemission | date:'dd/MM/yyyy' }}</p>
              <p><strong>Devise:</strong><br>{{ devise }}</p>
            </div>
            <div class="col-lg-6">
              <p><strong>Date d'échéance:</strong><br>{{ dateEcheance | date:'dd/MM/yyyy' }}</p>
              <p><strong>Banque:</strong><br>{{ getBanqueName() }}</p>
              <p><strong>Taux de change:</strong><br>{{ getTauxDisplay() }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Conditions financières</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-6">
              <p><strong>Commande:</strong><br>{{ commande }}%</p>
              <p><strong>Livraison:</strong><br>{{ livraison }}%</p>
              <p><strong>Validité:</strong><br>{{ validiteOffre }} jours</p>
            </div>
            <div class="col-lg-6">
              <p><strong>Délai de livraison:</strong><br>{{ getDelaiText() }}</p>
              <p><strong>TVA:</strong><br>{{ tvaActive ? (tva + '%') : 'Non applicable' }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lignes du devis -->
  <!-- Section Lignes de produits ou services -->
<div class="card mb-4">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Lignes de produits ou services <span class="text-danger">*</span></h6>
    
    
  </div>
  
  <div class="card-body">
    
    <div *ngIf="errors.lignes" class="alert alert-danger">
      {{ errors.lignes }}
    </div>
    
    <!-- Formulaire des lignes (étape 1) -->
    <div *ngIf="step">
      <div *ngFor="let ligne of lignes; let i = index" class="row mb-3 align-items-center">
        <div class="col-lg-4">
          <label class="form-label">Désignation</label>
          <select class="form-select" 
                  [class.is-invalid]="errors['ligne_' + i + '_designation']"
                  [(ngModel)]="ligne.designationId"
                  (change)="onDesignationChange(ligne, i)">
            <option [ngValue]="null">-- Sélectionner une désignation --</option>
            <option *ngFor="let d of filteredDesignations()" [ngValue]="d.id">
              {{ d.libelle }} - {{ d.prix_unitaire | number:'1.2-2' }} {{ deviseDepart }}
            </option>
          </select>
          <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_designation']">
            {{ errors['ligne_' + i + '_designation'] }}
          </div>
        </div>
        
        <div class="col-lg-1">
          <label class="form-label">Qté</label>
          <input type="number" class="form-control" 
                 [class.is-invalid]="errors['ligne_' + i + '_quantite']"
                 placeholder="Qté" 
                 [(ngModel)]="ligne.quantite" 
                 (input)="onLineChange()" 
                 min="1" step="1">
          <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_quantite']">
            {{ errors['ligne_' + i + '_quantite'] }}
          </div>
        </div>
        
        <div class="col-lg-2">
          <label class="form-label">Prix Unitaire</label>
          <input type="number" class="form-control" 
                 [class.is-invalid]="errors['ligne_' + i + '_prix']"
                 placeholder="Prix" 
                 [(ngModel)]="ligne.prix" 
                 (input)="onLineChange()" 
                 step="0.01" min="0">
          <div class="invalid-feedback" *ngIf="errors['ligne_' + i + '_prix']">
            {{ errors['ligne_' + i + '_prix'] }}
          </div>
        </div>
        
        <div class="col-lg-1">
          <label class="form-label">Remise %</label>
          <input type="number" class="form-control" 
                 placeholder="%" 
                 [(ngModel)]="ligne.remise" 
                 (input)="onLineChange()" 
                 min="0" max="100" step="0.01">
        </div>
        
        <div class="col-lg-2">
          <label class="form-label">Prix Net</label>
          <input type="number" class="form-control" 
                 placeholder="Prix Net" 
                 [value]="ligne.prixNet || 0" 
                 readonly>
        </div>
        
        <div class="col-lg-1">
          <label class="form-label">Total</label>
          <input type="number" class="form-control" 
                 placeholder="Total" 
                 [value]="ligne.total || 0" 
                 readonly>
        </div>
        
        <div class="col-lg-1">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-danger btn-sm w-100" (click)="removeLine(i)" title="Supprimer cette ligne">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <button class="btn btn-outline-primary btn-sm" (click)="addLine()">
            <i class="fas fa-plus me-1"></i>Ajouter une ligne
          </button>
        </div>
      </div>
    </div>
    
    <!-- Affichage des lignes en lecture seule (étape 2) -->
    <div *ngIf="step === 2" class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th width="40%">Désignation</th>
            <th width="10%" class="text-center">Quantité</th>
            <th width="15%" class="text-end">Prix Unitaire</th>
            <th width="10%" class="text-center">Remise</th>
            <th width="15%" class="text-end">Prix Net</th>
            <th width="10%" class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let l of lignes; let i = index">
            <td>{{ getDesignationName(l.designationId) }}</td>
            <td class="text-center">{{ l.quantite }}</td>
            <td class="text-end">{{ l.prix | number:'1.2-2' }} {{ devise }}</td>
            <td class="text-center">{{ l.remise || 0 }}%</td>
            <td class="text-end">{{ l.prixNet | number:'1.2-2' }} {{ devise }}</td>
            <td class="text-end">{{ l.total | number:'1.2-2' }} {{ devise }}</td>
          </tr>
        </tbody>
        <tfoot class="table-light">
          <tr>
            <td colspan="4" class="text-end"><strong>Total HT:</strong></td>
            <td colspan="2" class="text-end"><strong>{{ totalHT | number:'1.2-2' }} {{ devise }}</strong></td>
          </tr>
          <tr *ngIf="tvaActive">
            <td colspan="4" class="text-end"><strong>TVA ({{ tva }}%):</strong></td>
            <td colspan="2" class="text-end"><strong>{{ totalTVA | number:'1.2-2' }} {{ devise }}</strong></td>
          </tr>
          <tr>
            <td colspan="4" class="text-end"><strong>Total TTC:</strong></td>
            <td colspan="2" class="text-end"><strong>{{ totalTTC | number:'1.2-2' }} {{ devise }}</strong></td>
          </tr>
          <tr>
            <td colspan="4" class="text-end"><strong>Acompte ({{ commande }}%):</strong></td>
            <td colspan="2" class="text-end"><strong>{{ acompte | number:'1.2-2' }} {{ devise }}</strong></td>
          </tr>
          <tr>
            <td colspan="4" class="text-end"><strong>Solde:</strong></td>
            <td colspan="2" class="text-end"><strong>{{ solde | number:'1.2-2' }} {{ devise }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

  

  <!-- Boutons d'actions -->
  <div class="d-flex justify-content-between mt-4">
    <button class="btn btn-secondary" (click)="previousStep()">
      <i class="fas fa-arrow-left me-2"></i> Retour
    </button>
    
    <div>
      <button class="btn btn-outline-secondary me-2" (click)="cancel()">
        <i class="fas fa-times me-2"></i> Annuler
      </button>
      <button class="btn btn-success" (click)="saveDevis()">
        <i class="fas fa-save me-2"></i> Mettre à jour
      </button>
    </div>
  </div>

  <!-- Message de statut -->
  <div *ngIf="devis.status" class="alert alert-warning mt-3">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Statut actuel:</strong> {{ devis.status }}
    <span *ngIf="devis.status === 'Validé'" class="badge bg-success ms-2">Validé</span>
    <span *ngIf="devis.status === 'Réfusé'" class="badge bg-danger ms-2">Refusé</span>
    <span *ngIf="devis.status === 'En Attente de validation'" class="badge bg-warning ms-2">En attente</span>
  </div>
</div>