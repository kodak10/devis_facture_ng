<div class="container-fluid">
  <div class="row">
    <!-- Partie gauche : détails du devis -->
    <div class="col-lg-7">
      <div class="card border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Détails du Devis - Facture Totale
          </h5>
        </div>
        <div class="card-body">
          <div *ngIf="isLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement du devis...</p>
          </div>

          <div *ngIf="!isLoading && devis" class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr>
                  <th>Désignation</th>
                  <th width="100" class="text-center">Quantité</th>
                  <th width="120" class="text-end">Prix Unitaire</th>
                  <th width="120" class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ligne of devis.lignes">
                  <td>{{ ligne.designation?.libelle }}</td>
                  <td class="text-center">{{ ligne.quantite }}</td>
                  <td class="text-end">{{ ligne.prix_unitaire | number:'1.2-2' }} {{ ligne.devise }}</td>
                  <td class="text-end">{{ ligne.total | number:'1.2-2' }} {{ ligne.devise }}</td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="table-active">
                  <td colspan="3" class="text-end fw-bold">Total HT :</td>
                  <td class="text-end fw-bold">{{ devis.total_ht | number:'1.2-2' }} {{ devis.devise }}</td>
                </tr>
                <tr class="table-active">
                  <td colspan="3" class="text-end fw-bold">TVA ({{ devis.tva }}%) :</td>
                  <td class="text-end fw-bold">{{ (devis.total_ttc - devis.total_ht) | number:'1.2-2' }} {{ devis.devise }}</td>
                </tr>
                <tr class="table-active">
                  <td colspan="3" class="text-end fw-bold">Total TTC :</td>
                  <td class="text-end fw-bold text-success">{{ devis.total_ttc | number:'1.2-2' }} {{ devis.devise }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Partie droite : formulaire de création -->
    <div class="col-lg-5">
      <div class="card border-0">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-file-invoice-dollar me-2"></i>
            Création Facture Totale
          </h5>
        </div>
        <div class="card-body">
          <form (ngSubmit)="onSubmit()" #factureForm="ngForm">

            <div class="mb-3">
              <label class="form-label">Libellé de la facture <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="factureData.libelle" name="libelle" required>
            </div>

            <!-- Montant TTC -->
            <div class="mb-3">
              <label class="form-label">Montant TTC</label>
              <input type="text" class="form-control" [value]="totalMontant | number:'1.2-2'" readonly>
            </div>

            <div class="mb-3">
              <label class="form-label">Remise spéciale</label>
              <input type="number" [(ngModel)]="factureData.remise_speciale" name="remise_speciale" class="form-control" min="0" step="0.01">
            </div>

            <div class="mb-3">
              <label class="form-label">Numéro BC <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="factureData.num_bc" name="num_bc" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Numéro RAP</label>
              <input type="text" class="form-control" [(ngModel)]="factureData.num_rap" name="num_rap">
            </div>

            <div class="mb-3">
              <label class="form-label">Numéro BL</label>
              <input type="text" class="form-control" [(ngModel)]="factureData.num_bl" name="num_bl">
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success" [disabled]="isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                {{ isLoading ? 'Création...' : 'Créer la facture totale' }}
              </button>

              <button type="button" class="btn btn-warning" (click)="openDevisPdf()">
                <i class="fas fa-file-pdf me-2"></i> Ouvrir la Proforma PDF
              </button>

              <a routerLink="/factures" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i> Retour
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
