<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-12">
      <h4>Règlement des factures approuvées</h4>
    </div>
  </div>

  <div class="card border-0">
    <div class="card-body">
      <div *ngIf="isLoading" class="text-center py-3">
        <div class="spinner-border text-primary"></div>
        <p>Chargement des factures...</p>
      </div>

      <div *ngIf="!isLoading && facturesApprouvees.length === 0" class="text-center text-muted py-4">
        Aucune facture approuvée.
      </div>

      <div *ngIf="!isLoading && facturesApprouvees.length > 0" class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Num. Proforma</th>
              <th>Client</th>
              <th>Total TTC</th>
              <th>Montant Payé</th>
              <th>Établi par</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let f of facturesApprouvees">
              <td>{{ f.date_emission | date:'dd-MM-yyyy' }}</td>
              <td>{{ f.num_proforma }}</td>
              <td>{{ f.client_name }}</td>
              <td class="text-end">{{ f.total_ttc | number:'1.2-2' }} {{ f.devise }}</td>
                <td class="text-end">
                    {{ f.montant_paye | number:'1.2-2' }} {{ f.devise }}
                    <span class="badge ms-1" [ngClass]="f.isSolde ? 'bg-success' : 'bg-warning text-dark'">
                    {{ f.isSolde ? 'Soldé' : 'Non soldé' }}
                    </span>
                </td>              
                <td>{{ f.user_name }}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-secondary btn-sm me-1" title="Voir la Proforma" (click)="openDevisPdf(f.devis_id)">
                    <i class="fas fa-file-pdf"></i>
                    
                  </button>
                  <button class="btn btn-primary btn-sm me-1" title="Voir la Facture" (click)="openFacturePdf(f.id)">
                    <i class="fas fa-receipt"></i>
                  </button>
                  <button class="btn btn-success btn-sm me-1" title="Ajouter un règlement" (click)="openPaiementModal(paiementModal, f)">
                    <i class="fas fa-plus-circle"></i>
                  </button>
                  <button class="btn btn-info btn-sm" title="Historique des règlements" (click)="openHistoriqueModal(historiqueModal, f)">
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter Paiement -->
  <ng-template #paiementModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Ajouter un paiement</h5>
      <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <label>Montant payé</label>
      <input type="number" [(ngModel)]="paiementMontant" class="form-control" min="0">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.dismiss()">Annuler</button>
      <button class="btn btn-success" (click)="ajouterPaiement(modal)">Enregistrer</button>
    </div>
  </ng-template>

  <!-- Modal Historique Paiements -->
  <ng-template #historiqueModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Historique des règlement</h5>
      <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Montant</th>
            <th>Saisir Par</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of historiquePaiements">
            <td>{{ p.created_at | date:'dd-MM-yyyy' }}</td>
            <td>{{ p.montant | number:'1.2-2' }}</td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.close()">Fermer</button>
    </div>
  </ng-template>
</div>
